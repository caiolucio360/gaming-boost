// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                 @id @default(autoincrement())
  email              String              @unique
  name               String?
  password           String
  role               Role                @default(CLIENT)
  phone              String? // Telefone de contato
  taxId              String? // CPF/CNPJ para pagamentos
  active             Boolean             @default(true) // Se a conta está ativa
  metadata           String? // JSON com metadados adicionais
  // Chave PIX (para BOOSTER e ADMIN)
  pixKey             String? // Chave PIX para recebimento
  // Comissão personalizada do booster (opcional, usa config global se não definida)
  boosterCommissionPercentage Float? // Porcentagem de comissão personalizada (ex: 0.75 = 75%)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  orders             Order[] // Pedidos como cliente
  boosterOrders      Order[]             @relation("BoosterOrders") // Pedidos como booster
  adminOrders        Order[]             @relation("AdminOrders") // Pedidos como admin
  boosterCommissions BoosterCommission[] // Comissões como booster
  adminRevenues      AdminRevenue[] // Receitas como admin
  commissionHistory  BoosterCommissionHistory[] // Histórico de mudanças de comissão (como booster)
  commissionChanges   BoosterCommissionHistory[] @relation("CommissionChanges") // Mudanças feitas (como admin)
  boosterProfile     BoosterProfile?
  reviewsWritten     Review[]            @relation("ReviewAuthor")
  reviewsReceived    Review[]            @relation("ReviewTarget")
  notifications      Notification[]
  disputesCreated    Dispute[]           @relation("DisputeCreator")
  disputeMessages    DisputeMessage[]    @relation("MessageAuthor")
  image              String? // Avatar URL
}

model Service {
  id          Int         @id @default(autoincrement())
  game        Game
  type        ServiceType
  name        String
  description String
  price       Float
  duration    String
  enabled     Boolean     @default(true) // Se o serviço está ativo
  image       String? // URL da imagem do serviço
  metadata    String? // JSON com metadados adicionais
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orders      Order[]
}

model Order {
  id                Int                @id @default(autoincrement())
  userId            Int
  serviceId         Int
  boosterId         Int? // Booster atribuído ao pedido
  adminId           Int? // Admin responsável pelo pedido (quem recebe a receita)
  status            OrderStatus        @default(PENDING)
  total             Float
  // Valores de comissão e receita calculados
  boosterCommission Float? // Valor que o booster vai receber (calculado quando pedido é aceito)
  adminRevenue      Float? // Valor que o admin vai receber (calculado quando pedido é criado)
  boosterPercentage Float? // Porcentagem de comissão do booster (ex: 0.70 = 70%)
  adminPercentage   Float? // Porcentagem de receita do admin (ex: 0.30 = 30%)
  // Metadados do pedido
  currentRank       String? // Rank/pontuação atual (ex: "10K", "Nível 5")
  targetRank        String? // Rank/pontuação desejada (ex: "15K", "Nível 10")
  currentRating     Int? // Pontuação atual numérica (ex: 10000)
  targetRating      Int? // Pontuação desejada numérica (ex: 15000)
  gameMode          String? // Modo do jogo (ex: "PREMIER", "GAMERS_CLUB")
  gameType          String? // Tipo do jogo com modo (ex: "CS2_PREMIER")
  metadata          String? // JSON com metadados adicionais
  notes             String? // Notas adicionais do cliente ou booster
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  service           Service            @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  booster           User?              @relation("BoosterOrders", fields: [boosterId], references: [id], onDelete: SetNull)
  admin             User?              @relation("AdminOrders", fields: [adminId], references: [id], onDelete: SetNull)
  payments          Payment[] // Pagamentos associados ao pedido
  commission        BoosterCommission? // Comissão do booster
  revenue           AdminRevenue? // Receita do admin
  review            Review? // Avaliação do pedido
  dispute           Dispute? // Disputa do pedido

  // Índices para otimizar queries
  @@index([userId, gameMode, status]) // Para validação de modalidade duplicada (buscar pedidos ativos por modalidade)
  @@index([userId, status]) // Para buscar pedidos do usuário por status
  @@index([boosterId, status]) // Para buscar pedidos do booster por status
  @@index([adminId, status]) // Para buscar pedidos do admin por status
  @@index([serviceId]) // Para joins com Service
  @@index([status]) // Para filtros por status (admin/booster dashboards)
}

enum Role {
  CLIENT
  BOOSTER
  ADMIN
}

enum Game {
  CS2
}

enum ServiceType {
  RANK_BOOST
}

model Payment {
  id        Int       @id @default(autoincrement())
  orderId   Int
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  method    String    @default("PIX") // Método de pagamento
  providerId String? // ID externo do provider (AbacatePay, etc)
  pixCode   String? // Código PIX
  qrCode    String? // Base64 do QR Code
  status    String    @default("PENDING") // PENDING, PAID, EXPIRED, CANCELLED
  total     Float
  expiresAt DateTime?
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Comissão do booster - criada quando pedido é aceito
model BoosterCommission {
  id         Int              @id @default(autoincrement())
  orderId    Int              @unique
  boosterId  Int
  orderTotal Float // Valor total do pedido
  percentage Float // Porcentagem de comissão (ex: 0.70 = 70%)
  amount     Float // Valor da comissão calculada
  status     CommissionStatus @default(PENDING) // PENDING, PAID, CANCELLED
  paidAt     DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  order      Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  booster    User             @relation(fields: [boosterId], references: [id], onDelete: Cascade)

  @@index([boosterId, status])
  @@index([status])
}

enum CommissionStatus {
  PENDING // Aguardando pagamento
  PAID // Pago
  CANCELLED // Cancelado
}

// Receita do admin - criada quando pedido é criado
model AdminRevenue {
  id         Int           @id @default(autoincrement())
  orderId    Int           @unique
  adminId    Int
  orderTotal Float // Valor total do pedido
  percentage Float // Porcentagem de receita (ex: 0.30 = 30%)
  amount     Float // Valor da receita calculada
  status     RevenueStatus @default(PENDING) // PENDING, PAID, CANCELLED
  paidAt     DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  order      Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  admin      User          @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, status])
  @@index([status])
}

enum RevenueStatus {
  PENDING // Aguardando pagamento
  PAID // Pago
  CANCELLED // Cancelado
}

// Configuração de comissões (porcentagens)
model CommissionConfig {
  id                Int      @id @default(autoincrement())
  boosterPercentage Float    @default(0.70) // Porcentagem do booster (70% padrão)
  adminPercentage   Float    @default(0.30) // Porcentagem do admin (30% padrão)
  enabled           Boolean  @default(true) // Se a configuração está ativa
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Histórico de mudanças de comissão dos boosters
model BoosterCommissionHistory {
  id                    Int      @id @default(autoincrement())
  boosterId             Int
  booster               User     @relation(fields: [boosterId], references: [id], onDelete: Cascade)
  previousPercentage    Float?   // Porcentagem anterior (null se primeira vez)
  newPercentage         Float    // Nova porcentagem
  changedBy             Int      // ID do admin que fez a mudança
  changedByUser         User     @relation("CommissionChanges", fields: [changedBy], references: [id], onDelete: Restrict)
  reason                String?  // Motivo da mudança (opcional)
  createdAt             DateTime @default(now())

  @@index([boosterId])
  @@index([changedBy])
  @@index([createdAt])
}

model BoosterProfile {
  id                Int                  @id @default(autoincrement())
  userId            Int                  @unique
  user              User                 @relation(fields: [userId], references: [id])
  bio               String?
  languages         String[] // Array de idiomas
  verificationStatus VerificationStatus  @default(PENDING)
  rating            Float                @default(0)
  totalReviews      Int                  @default(0)
  completedOrders   Int                  @default(0)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([userId])
  @@index([verificationStatus])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Review {
  id        Int      @id @default(autoincrement())
  orderId   Int      @unique
  order     Order    @relation(fields: [orderId], references: [id])
  authorId  Int
  author    User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  boosterId Int
  booster   User     @relation("ReviewTarget", fields: [boosterId], references: [id])
  rating    Int // 1-5
  comment   String?
  createdAt DateTime @default(now())

  @@index([authorId])
  @@index([boosterId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  metadata  String? // JSON
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  ORDER_UPDATE
  PAYMENT
  SYSTEM
  CHAT
  BOOSTER_ASSIGNED
  COMMISSION
}

model Dispute {
  id        Int              @id @default(autoincrement())
  orderId   Int              @unique
  order     Order            @relation(fields: [orderId], references: [id])
  creatorId Int
  creator   User             @relation("DisputeCreator", fields: [creatorId], references: [id])
  reason    String
  status    DisputeStatus    @default(OPEN)
  messages  DisputeMessage[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([orderId])
  @@index([creatorId])
  @@index([status])
}

model DisputeMessage {
  id        Int      @id @default(autoincrement())
  disputeId Int
  dispute   Dispute  @relation(fields: [disputeId], references: [id])
  authorId  Int
  author    User     @relation("MessageAuthor", fields: [authorId], references: [id])
  content   String
  createdAt DateTime @default(now())

  @@index([disputeId])
  @@index([authorId])
}

enum DisputeStatus {
  OPEN
  RESOLVED_REFUND
  RESOLVED_PAYOUT
  RESOLVED_PARTIAL
  CANCELLED
}
