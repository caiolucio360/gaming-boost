// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 Int                 @id @default(autoincrement())
  email              String              @unique
  name               String?
  password           String
  role               Role                @default(CLIENT)
  phone              String? // Telefone de contato
  taxId              String? // CPF/CNPJ para pagamentos
  active             Boolean             @default(false) // Se a conta está ativa (requer verificação de email)
  metadata           String? // JSON com metadados adicionais
  // Chave PIX (para BOOSTER e ADMIN)
  pixKey             String? // Chave PIX para recebimento
  // Comissão personalizada do booster (opcional, usa config global se não definida)
  boosterCommissionPercentage Float? // Porcentagem de comissão personalizada (ex: 0.75 = 75%)
  // Porcentagem de divisão do lucro para admins (ex: 0.50 = 50% do lucro restante)
  adminProfitShare   Float?  @default(0) 
  isDevAdmin         Boolean             @default(false) // Se o usuário é Dev-Admin (recebe porcentagem antes do split)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  orders             Order[] // Pedidos como cliente
  boosterOrders      Order[]             @relation("BoosterOrders") // Pedidos como booster
  // adminOrders relation removed - AdminRevenue handles multi-admin revenue distribution
  boosterCommissions BoosterCommission[] // Comissões como booster
  adminRevenues      AdminRevenue[] // Receitas como admin
  devAdminRevenues   DevAdminRevenue[]   @relation("DevAdminRevenues") // Receitas como dev-admin
  commissionHistory  BoosterCommissionHistory[] // Histórico de mudanças de comissão (como booster)
  commissionChanges  BoosterCommissionHistory[] @relation("CommissionChanges") // Mudanças feitas (como admin)
  boosterProfile     BoosterProfile?
  reviewsWritten     Review[]            @relation("ReviewAuthor")
  reviewsReceived    Review[]            @relation("ReviewTarget")
  notifications      Notification[]
  disputesCreated    Dispute[]           @relation("DisputeCreator")
  disputeMessages    DisputeMessage[]    @relation("MessageAuthor")
  withdrawals        Withdrawal[]        // Saques solicitados
  image              String? // Avatar URL
  // Steam profile
  steamProfileUrl    String?              // URL do perfil Steam
  steamId            String?              // Steam64 ID
  verificationCodes  VerificationCode[]   // Códigos de verificação
}


model Order {
  id                Int                @id @default(autoincrement())
  userId            Int
  boosterId         Int? // Booster atribuído ao pedido
  game              Game               @default(CS2) // Jogo do pedido
  status            OrderStatus        @default(PENDING)
  total             Float

  // Metadados do pedido
  currentRank       String? // Rank/pontuação atual (ex: "10K", "Nível 5")
  targetRank        String? // Rank/pontuação desejada (ex: "15K", "Nível 10")
  currentRating     Int? // Pontuação atual numérica (ex: 10000)
  targetRating      Int? // Pontuação desejada numérica (ex: 15000)
  gameMode          String? // Modo do jogo (ex: "PREMIER", "GAMERS_CLUB")
  gameType          String? // Tipo do jogo com modo (ex: "CS2_PREMIER")
  metadata          String? // JSON com metadados adicionais
  // Credenciais Steam do cliente (criptografadas)
  steamCredentials  String?            // Credenciais criptografadas (username + password)
  steamProfileUrl   String?            // URL do perfil Steam do cliente
  steamConsent      Boolean            @default(false) // Cliente consentiu compartilhar credenciais
  steamConsentAt    DateTime?          // Data do consentimento
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  booster           User?              @relation("BoosterOrders", fields: [boosterId], references: [id], onDelete: SetNull)
  payments          Payment[] // Pagamentos associados ao pedido
  commission        BoosterCommission? // Comissão do booster
  revenues          AdminRevenue[] // Receitas dos admins (múltiplo - via AdminRevenue model)
  devAdminRevenue   DevAdminRevenue? // Receita do dev-admin
  review            Review? // Avaliação do pedido
  dispute           Dispute? // Disputa do pedido

  // Índices para otimizar queries
  @@index([userId, gameMode, status]) // Para validação de modalidade duplicada (buscar pedidos ativos por modalidade)
  @@index([userId, status]) // Para buscar pedidos do usuário por status
  @@index([boosterId, status]) // Para buscar pedidos do booster por status
  @@index([status]) // Para filtros por status (admin/booster dashboards)
}

enum Role {
  CLIENT
  BOOSTER
  ADMIN
}

enum Game {
  CS2
}

model Payment {
  id        Int       @id @default(autoincrement())
  orderId   Int
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  method    String    @default("PIX") // Método de pagamento
  providerId String? // ID externo do provider (AbacatePay, etc)
  pixCode   String? // Código PIX
  qrCode    String? // Base64 do QR Code
  status    PaymentStatus @default(PENDING)
  total     Float
  expiresAt DateTime?
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum PaymentStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
  REFUNDED
}

enum OrderStatus {
  PENDING
  PAID
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Comissão do booster - criada quando pedido é aceito
model BoosterCommission {
  id         Int              @id @default(autoincrement())
  orderId    Int              @unique
  boosterId  Int
  orderTotal Float // Valor total do pedido
  percentage Float // Porcentagem de comissão (ex: 0.70 = 70%)
  amount     Float // Valor da comissão calculada
  status     CommissionStatus @default(PENDING) // PENDING, PAID, CANCELLED
  paidAt     DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  order      Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  booster    User             @relation(fields: [boosterId], references: [id], onDelete: Cascade)

  @@index([boosterId, status])
  @@index([status])
}

enum CommissionStatus {
  PENDING // Aguardando pagamento
  PAID // Pago
  CANCELLED // Cancelado
}

// Receita do admin - criada quando pedido é criado
model AdminRevenue {
  id         Int           @id @default(autoincrement())
  orderId    Int           // Removido @unique para permitir múltiplos admins
  adminId    Int
  orderTotal Float // Valor total do pedido
  percentage Float // Porcentagem de receita (ex: 0.30 = 30%)
  amount     Float // Valor da receita calculada
  status     RevenueStatus @default(PENDING) // PENDING, PAID, CANCELLED
  paidAt     DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  order      Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  admin      User          @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, status])
  @@index([status])
}

// Receita do dev-admin - criada quando pedido é criado
model DevAdminRevenue {
  id         Int           @id @default(autoincrement())
  orderId    Int           @unique
  devAdminId Int
  orderTotal Float // Valor total do pedido
  percentage Float // Porcentagem de receita (ex: 0.10 = 10%)
  amount     Float // Valor da receita calculada
  status     RevenueStatus @default(PENDING) // PENDING, PAID, CANCELLED
  paidAt     DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  order      Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  devAdmin   User          @relation("DevAdminRevenues", fields: [devAdminId], references: [id], onDelete: Cascade)

  @@index([devAdminId, status])
  @@index([status])
}

enum RevenueStatus {
  PENDING // Aguardando pagamento
  PAID // Pago
  CANCELLED // Cancelado
}

// Configuração de comissões (porcentagens)
model CommissionConfig {
  id                Int      @id @default(autoincrement())
  boosterPercentage Float    @default(0.70) // Porcentagem do booster (70% padrão)
  adminPercentage   Float    @default(0.30) // Porcentagem do admin (30% padrão)
  devAdminPercentage Float?   // Porcentagem do dev-admin (ex: 0.10 = 10% do total)
  enabled           Boolean  @default(true) // Se a configuração está ativa
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Histórico de mudanças de comissão dos boosters
model BoosterCommissionHistory {
  id                    Int      @id @default(autoincrement())
  boosterId             Int
  booster               User     @relation(fields: [boosterId], references: [id], onDelete: Cascade)
  previousPercentage    Float?   // Porcentagem anterior (null se primeira vez)
  newPercentage         Float    // Nova porcentagem
  changedBy             Int      // ID do admin que fez a mudança
  changedByUser         User     @relation("CommissionChanges", fields: [changedBy], references: [id], onDelete: Restrict)
  reason                String?  // Motivo da mudança (opcional)
  createdAt             DateTime @default(now())

  @@index([boosterId])
  @@index([changedBy])
  @@index([createdAt])
}

model BoosterProfile {
  id                Int                  @id @default(autoincrement())
  userId            Int                  @unique
  user              User                 @relation(fields: [userId], references: [id])
  bio               String?
  languages         String[] // Array de idiomas
  verificationStatus VerificationStatus  @default(PENDING)
  rating            Float                @default(0)
  totalReviews      Int                  @default(0)
  completedOrders   Int                  @default(0)
  // CS2 stats (Steam profile info is on User model)
  cs2Rank           String?              // Rank atual no CS2 (ex: "Global Elite")
  cs2PremierRating  Int?                 // Rating Premier (ex: 18500)
  cs2Hours          Int?                 // Horas jogadas no CS2
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([userId])
  @@index([verificationStatus])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Review {
  id        Int      @id @default(autoincrement())
  orderId   Int      @unique
  order     Order    @relation(fields: [orderId], references: [id])
  authorId  Int
  author    User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  boosterId Int
  booster   User     @relation("ReviewTarget", fields: [boosterId], references: [id])
  rating    Int // 1-5
  comment   String?
  createdAt DateTime @default(now())

  @@index([authorId])
  @@index([boosterId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  metadata  String? // JSON
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  ORDER_UPDATE
  PAYMENT
  SYSTEM
  CHAT
  BOOSTER_ASSIGNED
  COMMISSION
}

model Dispute {
  id        Int              @id @default(autoincrement())
  orderId   Int              @unique
  order     Order            @relation(fields: [orderId], references: [id])
  creatorId Int
  creator   User             @relation("DisputeCreator", fields: [creatorId], references: [id])
  reason    String
  status    DisputeStatus    @default(OPEN)
  messages  DisputeMessage[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([orderId])
  @@index([creatorId])
  @@index([status])
}

model DisputeMessage {
  id        Int      @id @default(autoincrement())
  disputeId Int
  dispute   Dispute  @relation(fields: [disputeId], references: [id])
  authorId  Int
  author    User     @relation("MessageAuthor", fields: [authorId], references: [id])
  content   String
  createdAt DateTime @default(now())

  @@index([disputeId])
  @@index([authorId])
}

enum DisputeStatus {
  OPEN
  RESOLVED_REFUND
  RESOLVED_PAYOUT
  RESOLVED_PARTIAL
  CANCELLED
}

// Modelo para rastrear saques PIX de boosters e admins
model Withdrawal {
  id          Int              @id @default(autoincrement())
  userId      Int
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  providerId  String?          // ID do saque no AbacatePay (tran_123456)
  externalId  String           @unique  // ID único no nosso sistema
  amount      Int              // Valor em centavos
  platformFee Int?             // Taxa da plataforma
  pixKeyType  String           // CPF, CNPJ, EMAIL, PHONE, RANDOM, BR_CODE
  pixKey      String           // Valor da chave PIX
  status      WithdrawalStatus @default(PENDING)
  receiptUrl  String?
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  completedAt DateTime?

  @@index([userId, status])
  @@index([status])
  @@index([providerId])
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETE
  FAILED
  CANCELLED
}

// Configuração de preços por faixa
// Cada faixa representa um range (ex: Premier 0-5000 = R$25/1000, GC Level 1-10 = R$20/level)
model PricingConfig {
  id          Int      @id @default(autoincrement())
  game        Game     // CS2, etc
  gameMode    String   // PREMIER, GAMERS_CLUB
  rangeStart  Int      // Início da faixa (ex: 0, 5000, 10000 para Premier ou 1, 11, 15 para GC)
  rangeEnd    Int      // Fim da faixa (ex: 4999, 9999, 14999 para Premier ou 10, 14, 17 para GC)
  price       Float    // Preço por unidade (ex: 25.00 por 1000 pontos ou 20.00 por nível)
  unit        String   // Descrição da unidade (ex: "1000 pontos", "1 nível")
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([game, gameMode, rangeStart]) // Não pode ter duas configs para o mesmo range
  @@index([game, gameMode, enabled])
}



model VerificationCode {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String   // Código de 6 dígitos
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([code])
}
