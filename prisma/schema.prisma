// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  name          String?
  password      String
  role          Role     @default(CLIENT)
  phone         String? // Telefone de contato
  active        Boolean  @default(true) // Se a conta está ativa
  metadata      String? // JSON com metadados adicionais
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[] // Pedidos como cliente
  boosterOrders Order[]  @relation("BoosterOrders") // Pedidos como booster
}

model Service {
  id          Int         @id @default(autoincrement())
  game        Game
  type        ServiceType
  name        String
  description String
  price       Float
  duration    String
  enabled     Boolean     @default(true) // Se o serviço está ativo
  image       String? // URL da imagem do serviço
  metadata    String? // JSON com metadados adicionais
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orders      Order[]
}

model Order {
  id            Int         @id @default(autoincrement())
  userId        Int
  serviceId     Int
  boosterId     Int? // Booster atribuído ao pedido
  status        OrderStatus @default(PENDING)
  total         Float
  // Metadados do pedido
  currentRank   String? // Rank/pontuação atual (ex: "10K", "Nível 5")
  targetRank    String? // Rank/pontuação desejada (ex: "15K", "Nível 10")
  currentRating Int? // Pontuação atual numérica (ex: 10000)
  targetRating  Int? // Pontuação desejada numérica (ex: 15000)
  gameMode      String? // Modo do jogo (ex: "PREMIER", "GAMERS_CLUB")
  gameType      String? // Tipo do jogo com modo (ex: "CS2_PREMIER")
  metadata      String? // JSON com metadados adicionais
  notes         String? // Notas adicionais do cliente ou booster
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  booster       User?       @relation("BoosterOrders", fields: [boosterId], references: [id], onDelete: SetNull)
  payments      Payment[] // Pagamentos associados ao pedido

  // Índices para otimizar queries
  @@index([userId, gameMode, status]) // Para validação de modalidade duplicada (buscar pedidos ativos por modalidade)
  @@index([userId, status]) // Para buscar pedidos do usuário por status
  @@index([boosterId, status]) // Para buscar pedidos do booster por status
  @@index([serviceId]) // Para joins com Service
  @@index([status]) // Para filtros por status (admin/booster dashboards)
}

enum Role {
  CLIENT
  BOOSTER
  ADMIN
}

enum Game {
  CS2
}

enum ServiceType {
  RANK_BOOST
}

model Payment {
  id        Int       @id @default(autoincrement())
  orderId   Int
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  method    String    @default("PIX") // Método de pagamento
  pixCode   String? // Código PIX
  qrCode    String? // Base64 do QR Code
  status    String    @default("PENDING") // PENDING, PAID, EXPIRED, CANCELLED
  total     Float
  expiresAt DateTime?
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
